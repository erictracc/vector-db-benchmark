version: "3.9"

services:
  ### --- MILVUS Vector Database Stack --- ###
  etcd:
    image: quay.io/coreos/etcd:v3.5.5
    container_name: milvus-etcd
    environment:
      - ETCD_NAME=etcd
      - ETCD_AUTO_COMPACTION_MODE=revision
      - ETCD_AUTO_COMPACTION_RETENTION=1000
      - ETCD_QUOTA_BACKEND_BYTES=4294967296
      - ETCD_LISTEN_CLIENT_URLS=http://0.0.0.0:2379
      - ETCD_ADVERTISE_CLIENT_URLS=http://etcd:2379
      - ETCD_LISTEN_PEER_URLS=http://0.0.0.0:2380
      - ETCD_INITIAL_ADVERTISE_PEER_URLS=http://etcd:2380
      - ETCD_INITIAL_CLUSTER=etcd=http://etcd:2380
      - ETCD_INITIAL_CLUSTER_STATE=new
      - ETCD_INITIAL_CLUSTER_TOKEN=etcd-cluster
    volumes:
      - milvus_etcd_data:/etcd
    networks:
      - vector-net

  minio:
    image: minio/minio:RELEASE.2023-09-30T07-02-29Z
    container_name: milvus-minio
    environment:
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin
    command: server /data
    ports:
      - "9100:9000"
    volumes:
      - milvus_minio_data:/data
    networks:
      - vector-net

  milvus:
    image: milvusdb/milvus:v2.4.0
    container_name: milvus-vector-db
    depends_on:
      - etcd
      - minio
    command: ["milvus", "run", "standalone"]
    environment:
      ETCD_ENDPOINTS: etcd:2379
      MINIO_ADDRESS: minio:9000
    ports:
      - "19530:19530"  # gRPC API
      - "9092:9091"    # REST API (remapped)
    volumes:
      - milvus_data:/var/lib/milvus
    networks:
      - vector-net

  milvus-insight:
    image: milvusdb/milvus-insight:latest
    container_name: milvus-insight
    depends_on:
      - milvus
    environment:
      MILVUS_URL: http://milvus-vector-db:9091
    ports:
      - "8085:3000"
    networks:
      - vector-net

  ### --- WEAVIATE Vector Database Stack --- ###
  weaviate:
    image: semitechnologies/weaviate:1.24.6
    container_name: weaviate-vector-db
    restart: unless-stopped
    environment:
      QUERY_DEFAULTS_LIMIT: 25
      AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED: 'true'
      PERSISTENCE_DATA_PATH: /var/lib/weaviate
      DEFAULT_VECTORIZER_MODULE: none
      CLUSTER_HOSTNAME: weaviate
    ports:
      - "8084:8080"
    volumes:
      - weaviate_data:/var/lib/weaviate
    networks:
      - vector-net

  weaviate-console:
    image: semitechnologies/weaviate-console:latest
    container_name: weaviate-console
    depends_on:
      - weaviate
    environment:
      WEAVIATE_ENDPOINT: http://weaviate-vector-db:8080
    ports:
      - "8086:8080"
    networks:
      - vector-net

volumes:
  milvus_etcd_data:
  milvus_minio_data:
  milvus_data:
  weaviate_data:

networks:
  vector-net:
